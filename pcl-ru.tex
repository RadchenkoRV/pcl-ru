\documentclass{book}

% \batchmode
%\usepackage{alphalph}
%\usepackage[alphMult=0,AlphMulti=0]{pagesLTS}

\overfullrule=4bp

% \includeonly{% titlepage,from-publisher,preface,chapter-01,chapter-02,chapter-03,% chapter-04,chapter-05,chapter-06,chapter-07,chapter-08,chapter-09,chapter-10,chapter-11% ,chapter-12,chapter-13,chapter-14,chapter-15,chapter-16,chapter-17,chapter-18,chapter-19,
% chapter-20,chapter-21,chapter-22,chapter-23,chapter-24,chapter-25,chapter-26,chapter-27,chapter-28,chapter-29,chapter-30% ,chapter-31,chapter-32
% ,bibl,index% exercises% ,conventions}

\newif\ifCharter
\Chartertrue
% \Charterfalse

\usepackage{url}
\newcommand{\pclURL}[2]{\href{#1}{#2}\footnote{\href{#1}{#1}}}

%\usepackage{fonts}


\usepackage[utf8]{inputenc}
\usepackage[russian]{babel}
\usepackage{epigraph}
\usepackage{fancyvrb}
\usepackage[dvips]{color}
\usepackage{stmaryrd}
\usepackage{tabularx,mdwtab}
\usepackage{ifmtarg}
\usepackage{centernot}
\usepackage{empheq}
\usepackage{needspace}
%% \usepackage{colonequals}
%\usepackage{tikz}
%\usetikzlibrary{calc,trees,positioning,arrows,chains,shapes.geometric,%
%  decorations.pathreplacing,decorations.pathmorphing,shapes,%
%  matrix,shapes.symbols,decorations.shapes,decorations.markings,fit}

\makeatletter

%\pgfarrowsdeclare{mdiamond}{mdiamond}%{{-.5bp}{14.5bp}}
%{
%  \pgfutil@tempdima=0.4pt%
%  \advance\pgfutil@tempdima by.275\pgflinewidth%
%  \pgfarrowsleftextend{+-.5\pgflinewidth}
%  \pgfutil@tempdimb=14\pgfutil@tempdima\advance\pgfutil@tempdimb by.5\pgflinewidth
%  \pgfarrowsrightextend{+\pgfutil@tempdimb}
%}
%{
%  \pgfutil@tempdima=0.4pt%
%  \advance\pgfutil@tempdima by.275\pgflinewidth%
%  \pgfsetdash{}{+0pt}
%  \pgfsetroundjoin
%  \pgfpathmoveto{\pgfqpoint{14\pgfutil@tempdima}{0\pgfutil@tempdima}}
%  \pgfpathlineto{\pgfqpoint{4\pgfutil@tempdima}{4\pgfutil@tempdima}}
%  \pgfpathlineto{\pgfqpoint{0\pgfutil@tempdima}{0\pgfutil@tempdima}}
%  \pgfpathlineto{\pgfqpoint{4\pgfutil@tempdima}{-4\pgfutil@tempdima}}
%  \pgfpathclose
%  \pgfusepathqstroke
%}
\makeatother

%\tikzset{
%>=stealth',
%  phase/.style={
%    rectangle, 
%    rounded corners, 
%    % fill=black!10,
%    draw=black, very thick,
%    text width=10em, 
%    minimum height=3em, 
%    text centered},
%  line/.style={draw=black, thin, ->,font=\scriptsize},
%  noarrow/.style={draw=black, thick, -},
%  every edge/.style={->,thick,shorten >=1pt},
%  into/.style={->, thin, dotted, >=mdiamond}
%}

%%% На команде \matrix спотыкается HeVeA, я ее (пока что?) просто затыкаю. -- goga
%HEVEA\renewcommand{\matrix}{}

\usepackage{makeidx}
\makeindex

%\usepackage{fancybox}
%% Я хотел использовать fancybox ради \ovalbox, но он определяет свой
%% собственный Verbatim, который конфликтует с fancyvrb.
%% В конце концов нужно будет либо выдернуть оттуда определение
%% \ovalbox, либо отказаться от fancyvrb. Пока что я просто не делаю
%% круглых углов.
\newcommand{\ovalbox}[1]{\fbox{#1}}

\usepackage{longtable,citehack,enumerate}
\usepackage[nottoc]{tocbibind}
%\usepackage[unicode,colorlinks=true,a4paper]{hyperref}
\usepackage[unicode,a4paper]{hyperref}
\definecolor{pfpcolorint}{rgb}{0,0.4,0}
\definecolor{pfpcolorext}{rgb}{0,0,0.6}

\hypersetup{colorlinks,
	linkcolor=pfpcolorint,
	citecolor=pfpcolorint,
	filecolor=pfpcolorext,
	urlcolor=pfpcolorext,
	bookmarksopen,bookmarksopenlevel=0,
	pdffitwindow,
	pdftitle={Practical Common Lisp},
	% pdfsubject={},
	% pdfkeywords={}
}

\usepackage{epigraph}

\beforeepigraphskip 0pt plus 1fill

\usepackage{fancyvrb}

\usepackage{url}
\usepackage[dvips]{color}
\usepackage{stmaryrd}
\usepackage{marginnote}
\usepackage{array}
\usepackage{ifmtarg}
\usepackage{centernot}
\usepackage{empheq}
\usepackage{needspace}
\usepackage{colonequals}
% \usepackage{lastpage}

\renewcommand{\ovalbox}[1]{\fbox{#1}}

\usepackage{longtable,citehack,enumerate}
\usepackage{tabularx}
\usepackage{mdwtab}
\usepackage[unicode]{hyperref}
\definecolor{pfpcolorint}{rgb}{0,0.4,0}
\definecolor{pfpcolorext}{rgb}{0,0,0.6}

% 70х100/16 -> 170mmх240mm
 \usepackage[papersize={160mm,220mm},asymmetric,% bindingoffset=5mm,
hmargin={1cm,1cm},vmargin={1cm,1cm},includehead,ignorefoot,heightrounded,headsep=12bp,headheight=12.5bp,footnotesep=10bp plus2bp minus2bp]{geometry}

% headers & footers
%% \usepackage{fancyhdr}
%% \pagestyle{fancy}
%\include{version}
%% \fancyhead{}
%% \fancyhead[RE,LO]{\slshape{\rightmark{}}}
%% \fancyhead[LE,RO]{\thepage{}}
%\fancyfoot{}
%\fancyfoot[LE,RO]{rev. \svnInfoMaxRevision}
% 
\usepackage{graphicx}
% \ifCharter
% \else
% \usepackage{svninfo}
% \input tapl-svninfo.tex
% \fi

\usepackage[round]{natbib}
\bibliographystyle{plainnat}
\renewcommand{\cite}{\citep} % ???? citep*
\newcommand{\citeterse}{\citep}
\newcommand{\citeyr}[1]{(\citeyear{#1})}
\newcommand{\citeyropen}[1]{\citeyear{#1}}
\newcommand{\longcite}[1]{\citeauthor{#1} \citeyearpar{#1}}
\newcommand{\fulllongcite}[1]{\citeauthor*{#1} \citeyearpar{#1}}
\newcommand{\citeopen}[1]{\citealp{#1}} % citealp*
\newcommand{\citeopenterse}[1]{\citealp{#1}}

\usepackage{bold-extra}
\usepackage{listings}
\definecolor{listingcomment}{gray}{0.3}
\lstset{%
  basicstyle=\footnotesize\upshape\ttfamily,
  showtabs=false, 
  showspaces=false, 
  showstringspaces=false,% OK?
  tabsize=2,
  commentstyle=\color{listingcomment},
  extendedchars=\true{},
  mathescape=\true{},% allows to use math symbols in listings - may be
                     % dangerous
  basewidth={.5em,.5em},% columns=fullflexible
  xleftmargin=.943em
}
\lstdefinestyle{lisp}{language=Lisp,keywordstyle=\bfseries}

\lstdefinestyle{lisprepl}{keywords={}}

%\newcommand{\code}[1]{\lstinline[mathescape]|#1|}
\DeclareRobustCommand{\code}[1]{\texttt{\texorpdfstring{\def\ldots{...}%
\spaceskip\codespaceskip\relax}{}% \spaceskip3bp plus 1.5bp minus1bp\relax 
#1}}
\def\codespaceskip{\the\spaceskip}
\newcommand{\stdcode}[1]{\code{#1}}

%% proper captions for figures, etc
%\usepackage{caption}
%\DeclareCaptionLabelSeparator{Period}{.\hskip.5em}
%\captionsetup{compatibility=false,margin={-1cm,0pt},oneside,labelsep=Period,labelfont=sc,
%format=plain,justification=raggedright,singlelinecheck=false,skip=10bp}


% Добавляем точку после номера раздела
%% \usepackage{titlesec}
%% \titlelabel{\thetitle.\quad}
%% \usepackage[dotinlabels]{titletoc}

%% 

% settings for floating objects
\renewcommand{\topfraction}{.9}
\renewcommand{\textfraction}{.1}
\renewcommand{\bottomfraction}{.9}
\setcounter{totalnumber}{2}

%\renewcommand{\floatpagefraction}{.9}
%\renewcommand{\dblfloatpagefraction}{\floatpagefraction}
% \setcounter{topnumber}{4}
% \setcounter{bottomnumber}{4}
% \setlength{\floatsep}{8pt plus 2pt minus 2pt}
% \setlength{\textfloatsep}{8pt plus 2pt minus 2pt}
% \setlength{\intextsep}{12pt plus 2pt minus 2pt}

% Custom commands
\newcommand{\<}{\langle}
\renewcommand{\>}{\rangle}
\newcommand{\nbdash}{\mbox{-}}
\newcommand{\nosol}{\ensuremath{\nrightarrow}}
\newcommand{\recommended}{\textsc{Рекомендуется}}

\newcommand{\lambdaterm}[1]{\mbox{\code{#1}}}
\newcommand{\nbcode}[1]{\mbox{\code{#1}}}
\newcommand{\ocode}[1]{\overline{\vphantom{A}\code{#1}}}

\newcommand{\defterm}[1]{\emph{#1}}

\newcommand{\ruleid}[1]{\mbox{\textsc{#1}}}
%% \newcommand{\ruletag}[1]{\tag{\textsc{#1}}\index{правило!\textsc{#1}}}

\newcommand{\N}{\mathbb{N}}
\newcommand{\dom}{\textit{dom}}
\newcommand{\range}{\textit{range}}
\newcommand{\fail}{\textit{неудача}}
\newcommand{\function}[1]{\mbox{\textit{#1}\,}}
\newcommand{\interpreter}[1]{\texttt{#1}\index{интерпретатор!\texttt{#1}}}

\renewcommand{\L}{\ensuremath{\lambda}}

\newcommand{\eqdef}{\stackrel{\text{\tiny def}}{=}}

%% \newcommand{\size}[1]{\bar #1 \bar}

%% \newcommand{\varrow}{\mbox{\strut\ensuremath{\:\Mapstochar\shortrightarrow\:}}}
\newcommand{\notsub}{\ensuremath{\centernot{\code{\textnormal{<:}}}}}

\fboxsep.25em
\definecolor{gray}{gray}{0.75}
\newcommand{\graybg}[1]{\colorbox{gray}{\mbox{#1}}}

\makeatletter
\newcommand{\translationnotemark}{{\renewcommand{\@makefnmark}{*}\footnotemark{}}}
\newcommand{\translationnotetext}[1]{{\renewcommand{\@makefnmark}{*}\footnotetext{#1 \@Acdash \emph{Прим. перев.}}}\addtocounter{footnote}{-1}}
\newcommand{\translationnote}[1]{\translationnotemark{}\translationnotetext{#1}}
\newcommand{\unmarkednote}[1]{{\renewcommand{\@makefnmark}{}\footnotemark{}\footnotetext{#1}}\addtocounter{footnote}{-1}}
\makeatother

\newcommand{\wearelazy}{\translationnote{При верстке перевода это правило не соблюдалось.}}

%% \newtheorem{definition}{\texttt{Определение}}[section]
%% \newtheorem{exercise}[definition]{\texttt{Упражнение}}
%% \newtheorem{axiom}[definition]{\texttt{Аксиома}}
%% \newtheorem{proposition}[definition]{\texttt{Утверждение}}
%% \newtheorem{lemma}[definition]{\texttt{Лемма}}
%% \newtheorem{theorem}[definition]{\texttt{Теорема}}
%% \newtheorem{convention}[definition]{\texttt{Соглашение}}
%% \newtheorem{corollary}[definition]{\texttt{Следствие}}
%% \newtheorem{example}[definition]{\texttt{Пример}}
%% \newtheorem{examples}[definition]{\texttt{Примеры}}

\newcommand{\errata}[1]{\relax}

\newcommand{\muheight}{\ensuremath{\mu\mbox{-height}}}
\newcommand{\recordc}[4]{\ensuremath{\code{#1}_#2{}^{#2\in #3..#4}}}

%% \newenvironment{exsolution}[1]
%%   {\par\smallskip\noindent
%%    \ref{#1}. \textsc{Решение:}}{}

%%%
%%% НОВАЯ ВЕРСТКА ТАБЛИЦ
%%%
%%% сначала идёт параграф с заголовком...

\newcommand{\nr}[1][4]{\unskip\hspace*{.5em}\linebreak[#1]\hspace*{0pt plus 1fill}}


\newlength{\tapltablewidth}
\setlength{\tapltablewidth}{\textwidth}
\addtolength{\tapltablewidth}{1cm}
\addtolength\tapltablewidth{-12pt}% {-2.8pt}

\newlength{\newdisplaywidth}
\setlength{\newdisplaywidth}{\textwidth}
\addtolength{\newdisplaywidth}{1cm}

\makeatletter
\newcommand{\displayNew}[3]{\leftskip-1cm
\@ifnotempty{#1}{{\leftskip 0pt plus1fill \hskip-1cm\hskip-\leftskip #1 \par}}

\@fleqntrue
\@mathmargin0pt
\mathindent0pt
\everydisplay{}
\def\spread@equation{\reset@strutbox@
  \openup2\jot \let\spread@equation\@empty}
\renewcommand{\mintagsep}{0pt}

%%% ... потом верхняя рамка
\makebox[\newdisplaywidth]{\rule[-.7ex]{.4pt}{.7ex}\hrulefill\rule[-.7ex]{.4pt}{.7ex}}

\vspace{3bp}

%%% ... потом две minipage, стоящие рядом через черточку
\makebox[\newdisplaywidth]{\begin{minipage}[t]{.5\tapltablewidth}
\tabcolsep2pt
#2
\end{minipage}\hfill
\vline\hfill
\begin{minipage}[t]{.5\tapltablewidth}
#3
\end{minipage}}

\vspace{3bp}

%%% ... потом нижняя рамка
\makebox[\newdisplaywidth]{\rule{.4pt}{.7ex}\hrulefill\rule{.4pt}{.7ex}}\par
}


%%%% Вместо displayOneCol

\newcommand{\displayNewA}[3]{\leftskip-1cm
#1

\@fleqntrue
\@mathmargin0pt
\mathindent0pt
\everydisplay{}
%%% ... потом верхняя рамка
\makebox[\newdisplaywidth]{\rule[-.7ex]{.4pt}{.7ex}\hrulefill\rule[-.7ex]{.4pt}{.7ex}}

\vspace{6bp}

%%% ... потом две minipage, стоящие рядом через черточку
\makebox[\newdisplaywidth]{\begin{minipage}[t]{\newdisplaywidth}
% \tabcolsep2pt
#2
\end{minipage}% \hfill
%% \begin{minipage}[t]{.5\newdisplaywidth}
%% % \tabcolsep2pt
%% #3
%% \end{minipage}
}

%%% ... потом нижняя рамка
\makebox[\newdisplaywidth]{\rule{.4pt}{.7ex}\hrulefill\rule{.4pt}{.7ex}}\par
}

\newcommand{\displayNewB}[3]{\leftskip-1cm
#1

\@fleqntrue
\@mathmargin0pt
\mathindent0pt
\everydisplay{}
%%% ... потом верхняя рамка
\makebox[\newdisplaywidth]{\rule[-.7ex]{.4pt}{.7ex}\hrulefill\rule[-.7ex]{.4pt}{.7ex}}

\vspace{6bp}

%%% ... потом две minipage, стоящие рядом через черточку
\makebox[\newdisplaywidth]{\begin{minipage}[t]{.5\newdisplaywidth}
% \tabcolsep2pt
#2
\end{minipage}% \hfill
\begin{minipage}[t]{.5\newdisplaywidth}
% \tabcolsep2pt
#3
\end{minipage}
}

%%% ... потом нижняя рамка
\makebox[\newdisplaywidth]{\rule{.4pt}{.7ex}\hrulefill\rule{.4pt}{.7ex}}\par
}



\newcommand{\tablesection}[2]{\textit{#1}\@ifmtarg{#2}{\relax}{\unskip\nobreak\hfil\penalty100\hbox{}\nobreak\hfill\smash[b]{\fbox{#2}}}}
\makeatother

\newcommand{\displayOneCol}[2]{
  { % hold \arraystretch redefinition inside the display
    #1 \\
    \renewcommand{\arraystretch}{0}
    \begin{tabular}{|c|}
      \hline
      \rule{0pt}{1ex} \\
      \multicolumn{1}{c}{
        \renewcommand{\arraystretch}{1}
        \begin{tabular}{l}
          #2
        \end{tabular}
      } \\
      \rule{0pt}{1ex} \\
      \hline
    \end{tabular}
  }
}



\newcommand\nextpage{\emph{См. след. страницу}}


\title{Practical Common Lisp}
\author{Peter Seibel}

%\usepackage{sections}


\begin{document}
% Don't remove! used for tikz nodes align!
\newlength{\tikztextheight}\settoheight{\tikztextheight}{!}
%
%% \newlength{\tapltablewidth}
%% \setlength{\tapltablewidth}{\linewidth}
%% \addtolength\tapltablewidth{-2.8pt}
\VerbatimFootnotes
%% \selectlanguage{russian}%
%% \frenchspacing
%% \righthyphenmin=2

%% TODO: remove...
\sloppy

\frontmatter

\makeatletter
\@nameuse{ttl@ps@\string\chapter}
\makeatother



%%% здесь можно комментировать одно и раскомментировать другое, чтобы
%%% быстро тестировать компиляцию по главам
%\input{chapter-13.tex}
\input{all-chapters}

\end{document}

%%% Local Variables: 
%%% mode: latex
%%% tex-command: "~/texlive/2010/bin/i386-linux/xelatex"
%%% TeX-master: t
%%% End: 
